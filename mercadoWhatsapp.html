<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculadora de Mercado</title>
    <style>
        :root {
            --cor-fundo-pagina: #f4f4f9;
            --cor-fundo-card: #ffffff;
            --cor-texto-principal: #333333;
            --cor-texto-secundario: #666666;
            --cor-input-fundo: #fafafa;
            --cor-input-borda: #ddd;
            --cor-input-foco: #fff;
            --cor-cabecalho-fundo: #6200ea;
            --cor-cabecalho-editando: #2962ff;
            --cor-botao-deletar-fundo: #ffebee;
            --cor-botao-deletar-texto: #d32f2f;
            --cor-botao-editar-fundo: #fff8e1;
            --cor-botao-editar-texto: #f57f17;
            --cor-botao-limpar-fundo: #eceff1;
            --cor-botao-limpar-texto: #546e7a;
            --cor-rodape-fundo: #222222;
            --cor-rodape-borda: #444444;
            --sombra-padrao: rgba(0,0,0,0.05);
            --cor-item-hover: #fcfcfc;
            --cor-item-editando-fundo: #f0f7ff;
            --cor-item-editando-borda: #2962ff;
            --cor-checkbox-borda: #bbb;
            --cor-checkbox-fundo: #fff;
            --cor-checkbox-ativo: #00c853;
            --opacidade-inativo: 0.5;
        }

        body.modo-escuro {
            --cor-fundo-pagina: #121212;
            --cor-fundo-card: #1e1e1e;
            --cor-texto-principal: #e0e0e0;
            --cor-texto-secundario: #a0a0a0;
            --cor-input-fundo: #2c2c2c;
            --cor-input-borda: #444444;
            --cor-input-foco: #333333;
            --cor-cabecalho-fundo: #3700b3; 
            --cor-cabecalho-editando: #004ecb;
            --cor-botao-deletar-fundo: #4a0d0d;
            --cor-botao-deletar-texto: #ef9a9a; 
            --cor-botao-editar-fundo: #4a3b00;
            --cor-botao-editar-texto: #ffe082; 
            --cor-botao-limpar-fundo: #37474f;
            --cor-botao-limpar-texto: #b0bec5;
            --cor-rodape-fundo: #1e1e1e;
            --cor-rodape-borda: #333333;
            --sombra-padrao: rgba(0,0,0,0.3);
            --cor-item-hover: #252525;
            --cor-item-editando-fundo: #1a237e; 
            --cor-item-editando-borda: #536dfe;
            --cor-checkbox-borda: #666;
            --cor-checkbox-fundo: #2c2c2c;
            --cor-checkbox-ativo: #00e676;
            --opacidade-inativo: 0.4;
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0 0 180px 0; background-color: var(--cor-fundo-pagina); color: var(--cor-texto-principal); transition: background 0.3s, color 0.3s; }
        
        .cabecalho { background: var(--cor-cabecalho-fundo); color: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: background-color 0.3s; }
        .cabecalho.editando { background: var(--cor-cabecalho-editando); }
        
        .topo-cabecalho { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .cabecalho label { font-size: 0.8rem; opacity: 0.9; font-weight: 500; letter-spacing: 0.5px; }
        
        .acoes-cabecalho { display: flex; gap: 10px; align-items: center; }

        .botao-cabecalho { background: rgba(255,255,255,0.15); border: none; color: white; display: flex; align-items: center; justify-content: center; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-weight: bold; backdrop-filter: blur(5px); font-size: 0.75rem; }
        .botao-cabecalho:active { background: rgba(255,255,255,0.3); }
        .botao-cabecalho svg { width: 18px; height: 18px; fill: currentColor; }

        .entrada-orcamento { width: 100%; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); padding: 10px; font-size: 1.8rem; border-radius: 8px; color: white; font-weight: bold; }
        .entrada-orcamento::placeholder { color: rgba(255,255,255,0.4); }

        .cartao-adicionar { background: var(--cor-fundo-card); padding: 15px; margin-bottom: 10px; box-shadow: 0 4px 6px var(--sombra-padrao); }
        .grade-formulario { display: flex; flex-direction: column; gap: 12px; }
        .container-campo { display: flex; flex-direction: column; }
        .linha-entrada { display: flex; gap: 12px; }

        .entrada-estilizada { width: 100%; padding: 12px; border: 1px solid var(--cor-input-borda); border-radius: 8px; font-size: 1.1rem; background: var(--cor-input-fundo); color: var(--cor-texto-principal); transition: border 0.2s, background 0.2s; }
        .entrada-estilizada:focus { border-color: #6200ea; background: var(--cor-input-foco); }
        .entrada-preco { font-size: 1.3rem; font-weight: bold; }
        .entrada-qtd { text-align: center; }
        
        .etiqueta-pequena { font-size: 0.75rem; color: var(--cor-texto-secundario); margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }

        .linha-acoes { display: flex; gap: 10px; margin-top: 5px; }
        
        .botao-principal { flex: 4; background: #00c853; color: white; border: none; padding: 14px; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,200,83,0.2); text-transform: uppercase; letter-spacing: 1px; transition: background 0.2s; }
        .botao-principal:active { transform: scale(0.98); }
        .botao-principal.em-edicao { background: #2962ff; box-shadow: 0 4px 6px rgba(41, 98, 255, 0.2); }

        .botao-limpar { flex: 1; background: var(--cor-botao-limpar-fundo); color: var(--cor-botao-limpar-texto); border: 1px solid transparent; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .botao-limpar:active { opacity: 0.8; }

        .container-busca { padding: 0 15px 15px 15px; position: relative; }
        .entrada-busca { width: 100%; padding: 12px 12px 12px 40px; border: 1px solid var(--cor-input-borda); border-radius: 25px; font-size: 1rem; background: var(--cor-fundo-card); color: var(--cor-texto-principal); box-shadow: 0 2px 4px var(--sombra-padrao); }
        .icone-busca { position: absolute; left: 28px; top: 50%; transform: translateY(-60%); width: 18px; height: 18px; color: var(--cor-texto-secundario); opacity: 0.5; pointer-events: none; }

        .lista-itens { padding: 0 15px; }
        
        .cartao-item { background: var(--cor-fundo-card); padding: 12px 10px 12px 15px; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px var(--sombra-padrao); border-left: 5px solid transparent; transition: all 0.2s; }
        
        .cartao-item.item-editando { border-left-color: var(--cor-item-editando-borda); background-color: var(--cor-item-editando-fundo); }
        
        .cartao-item.inativo { opacity: var(--opacidade-inativo); filter: grayscale(0.8); }
        .cartao-item.inativo .nome-item { text-decoration: line-through; }

        .checkbox-customizado {
            position: relative;
            display: inline-block;
            width: 26px;
            height: 26px;
            cursor: pointer;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .checkbox-customizado input { opacity: 0; width: 0; height: 0; position: absolute; }

        .marca-checkbox {
            position: absolute;
            top: 0;
            left: 0;
            height: 26px;
            width: 26px;
            background-color: transparent;
            border: 2px solid var(--cor-checkbox-borda);
            border-radius: 7px;
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .checkbox-customizado input:checked ~ .marca-checkbox { background-color: var(--cor-checkbox-ativo); border-color: var(--cor-checkbox-ativo); }

        .marca-checkbox:after { content: ""; position: absolute; display: none; }
        .checkbox-customizado input:checked ~ .marca-checkbox:after { display: block; }

        .checkbox-customizado .marca-checkbox:after {
            left: 9px;
            top: 5px;
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 2.5px 2.5px 0;
            transform: rotate(45deg);
        }

        .conteudo-esquerdo { flex: 1; min-width: 0; margin-right: 10px; }
        .nome-item { font-weight: 600; font-size: 1.05rem; color: var(--cor-texto-principal); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .matematica-item { font-size: 0.85rem; color: var(--cor-texto-secundario); }

        .conteudo-direito { display: flex; align-items: center; gap: 8px; }
        .preco-total-item { font-weight: 800; font-size: 1.15rem; color: var(--cor-texto-principal); margin-right: 5px; }

        .botao-icone { border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: background 0.2s; }
        .botao-icone svg { width: 20px; height: 20px; fill: currentColor; }

        .botao-editar { background: var(--cor-botao-editar-fundo); color: var(--cor-botao-editar-texto); }
        .botao-editar:active { opacity: 0.8; }

        .botao-deletar { background: var(--cor-botao-deletar-fundo); color: var(--cor-botao-deletar-texto); }
        .botao-deletar:active { opacity: 0.8; }

        .rodape { position: fixed; bottom: 0; left: 0; right: 0; background: var(--cor-rodape-fundo); color: white; padding: 15px 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; z-index: 200; border-top: 1px solid var(--cor-rodape-borda); }
        .coluna-rodape { display: flex; flex-direction: column; }
        .rotulo-total { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; }
        .valor-total { font-size: 1.2rem; font-weight: bold; }
        .valor-saldo { font-size: 1.5rem; font-weight: 800; text-align: right; }
        .positivo { color: #00e676; } 
        .negativo { color: #ff5252; }
        
        .estado-vazio { text-align: center; color: var(--cor-texto-secundario); margin-top: 30px; padding: 20px; }
    </style>
</head>
<body>

    <div id="cabecalhoPrincipal" class="cabecalho">
        <div class="topo-cabecalho">
            <label>MEU OR√áAMENTO</label>
            <div class="acoes-cabecalho">
                <button id="botaoTema" class="botao-cabecalho" title="Alternar Tema"></button>
                <button id="botaoLimparTudo" class="botao-cabecalho">Limpar Tudo</button>
            </div>
        </div>
        <input type="tel" inputmode="numeric" id="entradaOrcamento" class="entrada-orcamento" placeholder="R$ 0,00">
    </div>

    <div class="cartao-adicionar" id="cartaoFormulario">
        <input type="hidden" id="idItem">
        <div class="grade-formulario">
            <div class="container-campo">
                <input type="text" id="entradaNome" class="entrada-estilizada entrada-completa" placeholder="Nome do produto (Opcional)">
            </div>
            <div class="linha-entrada">
                <div class="container-campo" style="flex: 2;">
                    <label class="etiqueta-pequena">Pre√ßo (R$)</label>
                    <input type="tel" inputmode="numeric" id="entradaPreco" class="entrada-estilizada entrada-preco" placeholder="0,00">
                </div>
                <div class="container-campo" style="flex: 1;">
                    <label class="etiqueta-pequena">Qtd</label>
                    <input type="tel" inputmode="numeric" id="entradaQtd" class="entrada-estilizada entrada-qtd" value="1" placeholder="1">
                </div>
            </div>
            <div class="linha-acoes">
                <button id="botaoSalvar" class="botao-principal">Adicionar Item</button>
                <button id="botaoLimparCampos" class="botao-limpar" title="Limpar Campos">
                    <svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentColor" d="M19.36,2.72L20.78,4.14L15.06,9.85C16.13,11.39 16.28,13.24 15.38,14.44L9.06,8.12C10.26,7.22 12.11,7.37 13.65,8.44L19.36,2.72M5.93,17.57C3.92,15.56 2.69,13.16 2.35,10.92L7.23,8.83L14.67,16.27L12.58,21.15C10.34,20.81 7.94,19.58 5.93,17.57Z" /></svg>
                </button>
            </div>
        </div>
    </div>

    <div class="container-busca">
        <svg class="icone-busca" viewBox="0 0 24 24"><path fill="currentColor" d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
        <input type="text" id="barraBusca" class="entrada-busca" placeholder="Buscar na lista...">
    </div>

    <div class="lista-itens" id="listaItens"></div>
    
    <div class="rodape">
        <div class="coluna-rodape">
            <span class="rotulo-total">Carrinho</span>
            <span class="valor-total" id="totalGasto">R$ 0,00</span>
        </div>
        <div class="coluna-rodape" style="align-items: flex-end;">
            <span class="rotulo-total">Dispon√≠vel</span>
            <span class="valor-saldo positivo" id="saldoRestante">R$ 0,00</span>
        </div>
    </div>

    <script>
        class CalculadoraException extends Error {
            constructor(mensagem) {
                super(mensagem)
            }
        }

        class Item {
            #id
            #nome
            #preco
            #qtd
            #ativo

            constructor({ id, nome, preco, qtd, ativo }) {
                this.#id = id ? id : Date.now()
                this.#nome = nome
                this.#preco = preco
                this.#qtd = qtd
                this.#ativo = ativo !== undefined ? ativo : true

                this.validar(nome, preco, qtd)
            }

            get id() { return this.#id }
            get nome() { return this.#nome }
            get preco() { return this.#preco }
            get qtd() { return this.#qtd }
            get ativo() { return this.#ativo }
            get total() { return this.#preco * this.#qtd }

            set nome(nome) {
                this.validar(nome, this.#preco, this.#qtd)
                this.#nome = nome
            }

            set preco(preco) {
                this.validar(this.#nome, preco, this.#qtd)
                this.#preco = preco
            }

            set qtd(qtd) {
                this.validar(this.#nome, this.#preco, qtd)
                this.#qtd = qtd
            }

            set ativo(ativo) {
                this.#ativo = ativo
            }

            validar(nome, preco, qtd) {
                if (!preco || preco < 0) {
                    throw new CalculadoraException("O pre√ßo √© inv√°lido")
                }
                if (!qtd || qtd <= 0 || !Number.isInteger(qtd)) {
                    throw new CalculadoraException("A quantidade deve ser um n√∫mero inteiro maior que zero")
                }
            }

            paraJSON() {
                return {
                    id: this.#id,
                    nome: this.#nome,
                    preco: this.#preco,
                    qtd: this.#qtd,
                    ativo: this.#ativo
                }
            }
        }

        class ServicoCalculadoraAsync {
            #chaveItens = "mercadoItens_v13"
            #chaveOrcamento = "mercadoOrcamento_v13"
            #chaveTema = "mercadoTema_v13"

            async cadastrar(obj) {
                return new Promise((resolver, rejeitar) => {
                    try {
                        const itens = this.#lerLocalStorage()
                        itens.push(obj.paraJSON())
                        this.#salvarLocalStorage(itens)
                        resolver(obj.id)
                    } catch (erro) {
                        rejeitar(new CalculadoraException("Erro ao salvar item"))
                    }
                })
            }

            async buscar() {
                return new Promise((resolver) => {
                    const dados = this.#lerLocalStorage()
                    const lista = dados.map(dado => new Item(dado))
                    resolver(lista)
                })
            }

            async buscarPorId(id) {
                return new Promise((resolver, rejeitar) => {
                    const itens = this.#lerLocalStorage()
                    const encontrado = itens.find(i => i.id == id)
                    if (encontrado) {
                        resolver(new Item(encontrado))
                    } else {
                        rejeitar(new CalculadoraException("Item n√£o encontrado"))
                    }
                })
            }

            async atualizar(obj) {
                return new Promise((resolver, rejeitar) => {
                    const itens = this.#lerLocalStorage()
                    const indice = itens.findIndex(i => i.id == obj.id)
                    if (indice !== -1) {
                        itens[indice] = obj.paraJSON()
                        this.#salvarLocalStorage(itens)
                        resolver()
                    } else {
                        rejeitar(new CalculadoraException("Erro ao atualizar item"))
                    }
                })
            }

            async excluir(id) {
                return new Promise((resolver) => {
                    let itens = this.#lerLocalStorage()
                    itens = itens.filter(i => i.id != id)
                    this.#salvarLocalStorage(itens)
                    resolver()
                })
            }

            async limparTodos() {
                return new Promise((resolver) => {
                    this.#salvarLocalStorage([])
                    resolver()
                })
            }

            obterOrcamento() {
                return parseFloat(localStorage.getItem(this.#chaveOrcamento)) || 0
            }

            salvarOrcamento(valor) {
                localStorage.setItem(this.#chaveOrcamento, valor)
            }

            obterTema() {
                return localStorage.getItem(this.#chaveTema)
            }

            salvarTema(tema) {
                localStorage.setItem(this.#chaveTema, tema)
            }

            #lerLocalStorage() {
                return JSON.parse(localStorage.getItem(this.#chaveItens)) || []
            }

            #salvarLocalStorage(dados) {
                localStorage.setItem(this.#chaveItens, JSON.stringify(dados))
            }
        }

        class ControladoraCalculadoraAsync {

            #visao
            #servico = new ServicoCalculadoraAsync()
            #termoBusca = ""

            constructor(visao) {
                this.#visao = visao
            }

            async iniciar() {
                this.#carregarTema()
                this.#carregarOrcamento()
                this.#atualizarLista()
            }

            async #atualizarLista() {
                try {
                    const todosItens = await this.#servico.buscar()
                    const itensFiltrados = todosItens.filter(i => 
                        i.nome.toLowerCase().includes(this.#termoBusca.toLowerCase())
                    )
                    this.#visao.exibir(itensFiltrados)
                    this.#calcularTotais(todosItens)
                } catch (erro) {
                    alert(erro.message)
                }
            }

            async salvar() {
                try {
                    const dados = this.#visao.lerFormulario()
                    const item = new Item(dados)

                    if (dados.id) {
                        await this.#servico.atualizar(item)
                    } else {
                        delete item.id
                        await this.#servico.cadastrar(item)
                    }
                    
                    this.#visao.limparFormulario()
                    await this.#atualizarLista()
                } catch (erro) {
                    alert(erro.message)
                }
            }

            async excluir(id) {
                if (confirm("Remover item?")) {
                    try {
                        await this.#servico.excluir(id)
                        this.#visao.limparFormulario()
                        await this.#atualizarLista()
                    } catch (erro) {
                        alert(erro.message)
                    }
                }
            }

            async alternarStatus(id) {
                try {
                    const item = await this.#servico.buscarPorId(id)
                    item.ativo = !item.ativo
                    await this.#servico.atualizar(item)
                    await this.#atualizarLista()
                } catch (erro) {
                    alert(erro.message)
                }
            }

            async limparTudo() {
                if (confirm("Apagar todas as compras?")) {
                    try {
                        await this.#servico.limparTodos()
                        this.#visao.limparFormulario()
                        await this.#atualizarLista()
                    } catch (erro) {
                        alert(erro.message)
                    }
                }
            }

            limparCampos() {
                this.#visao.limparFormulario()
            }

            buscar(termo) {
                this.#termoBusca = termo
                this.#atualizarLista()
            }

            alternarTema() {
                const temaAtual = this.#servico.obterTema()
                const novoTema = temaAtual === "escuro" ? "claro" : "escuro"
                this.#servico.salvarTema(novoTema)
                this.#aplicarTema(novoTema)
            }

            atualizarOrcamento(valorStr) {
                const valor = parseFloat(valorStr.replace(/\D/g, "")) / 100
                this.#servico.salvarOrcamento(valor)
                this.#atualizarLista()
            }

            #calcularTotais(itens) {
                const orcamento = this.#servico.obterOrcamento()
                const gasto = itens.reduce((acc, i) => i.ativo ? acc + i.total : acc, 0)
                this.#visao.atualizarTotais(gasto, orcamento - gasto)
            }

            #carregarOrcamento() {
                const orcamento = this.#servico.obterOrcamento()
                this.#visao.definirOrcamento(orcamento)
            }

            #carregarTema() {
                const salvo = this.#servico.obterTema()
                const sistemaEscuro = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
                const tema = salvo ? salvo : (sistemaEscuro ? "escuro" : "claro")
                this.#aplicarTema(tema)
            }

            #aplicarTema(tema) {
                this.#visao.definirTema(tema === "escuro")
            }
        }

        class VisaoCalculadoraDOM {
            
            #controladora = new ControladoraCalculadoraAsync(this)

            constructor() {
                this.botaoSalvar = document.getElementById("botaoSalvar")
                this.botaoLimpar = document.getElementById("botaoLimparCampos")
                this.botaoLimparTudo = document.getElementById("botaoLimparTudo")
                this.botaoTema = document.getElementById("botaoTema")
                this.barraBusca = document.getElementById("barraBusca")
                this.entradaOrcamento = document.getElementById("entradaOrcamento")
                this.entradaPreco = document.getElementById("entradaPreco")
                this.entradaQtd = document.getElementById("entradaQtd")
                this.elementoTotal = document.getElementById("totalGasto")
                this.elementoSaldo = document.getElementById("saldoRestante")
                this.cabecalho = document.getElementById("cabecalhoPrincipal")

                this.iconeSol = '<svg viewBox="0 0 24 24"><path d="M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,2L14.39,5.42C13.65,5.15 12.84,5 12,5C11.16,5 10.35,5.15 9.61,5.42L12,2M3.34,7L7.5,5.29C7.24,5.84 6.96,6.42 6.69,7L2.5,9L3.34,7M3.36,17L2.5,15L6.68,17C6.95,17.58 7.23,18.16 7.49,18.71L3.36,17M20.65,7L21.5,9L17.3,7C17.03,6.42 16.75,5.84 16.5,5.29L20.65,7M20.64,17L16.5,18.71C16.76,18.16 17.04,17.58 17.31,17L21.5,15L20.64,17M12,22L9.61,18.58C10.35,18.85 11.16,19 12,19C12.84,19 13.65,18.85 14.39,18.58L12,22Z" /></svg>'
                this.iconeLua = '<svg viewBox="0 0 24 24"><path d="M17.75,4.09L15.22,6.03L16.13,9.09L13.5,7.28L10.87,9.09L11.78,6.03L9.25,4.09L12.44,4L13.5,1L14.56,4L17.75,4.09M21.25,11L19.61,12.25L20.2,14.23L18.5,13.06L16.8,14.23L17.39,12.25L15.75,11L17.81,10.95L18.5,9L19.19,10.95L21.25,11M18.97,15.95C19.8,15.87 20.69,17.05 20.16,17.8C19.84,18.25 19.5,18.67 19.08,19.07C15.17,23 8.84,23 4.94,19.07C1.03,15.17 1.03,8.84 4.94,4.94C5.34,4.53 5.76,4.17 6.21,3.85C6.96,3.32 8.14,4.21 8.06,5.04C7.79,7.9 8.75,10.87 10.95,13.06C13.14,15.26 16.1,16.22 18.97,15.95M17.33,17.97C14.5,17.81 11.7,16.64 9.53,14.5C7.38,12.35 6.21,9.54 6.05,6.71C4.26,8.35 3.13,10.87 3.5,13.56C3.87,16.26 6.15,18.54 8.85,18.91C11.45,19.29 13.95,18.2 15.6,16.4C16.25,15.7 16.84,14.9 17.33,14Z" /></svg>'

                this.#registrarEventos()
            }

            async iniciar() {
                await this.#controladora.iniciar()
            }

            #registrarEventos() {
                this.botaoSalvar.addEventListener("click", () => this.#controladora.salvar())
                this.botaoLimpar.addEventListener("click", () => this.#controladora.limparCampos())
                this.botaoLimparTudo.addEventListener("click", () => this.#controladora.limparTudo())
                this.botaoTema.addEventListener("click", () => this.#controladora.alternarTema())
                this.barraBusca.addEventListener("keyup", (e) => this.#controladora.buscar(e.target.value))
                
                this.entradaOrcamento.addEventListener("keyup", (e) => {
                    this.aplicarMascara(e.target)
                    this.#controladora.atualizarOrcamento(e.target.value)
                })
                this.entradaPreco.addEventListener("keyup", (e) => this.aplicarMascara(e.target))
                this.entradaQtd.addEventListener("input", (e) => {
                    e.target.value = e.target.value.replace(/\D/g, "")
                })
            }

            exibir(listaItens) {
                const divLista = document.getElementById("listaItens")
                divLista.innerHTML = ""

                if (listaItens.length === 0) {
                    const vazio = document.createElement("div")
                    vazio.className = "estado-vazio"
                    vazio.innerText = "üõí Lista vazia / Nenhum item encontrado."
                    divLista.appendChild(vazio)
                    return
                }

                for (const item of listaItens) {
                    this.#criarElementoItem(item, divLista)
                }
            }

            #criarElementoItem(item, container) {
                const cartao = document.createElement("div")
                cartao.className = "cartao-item"
                if (!item.ativo) cartao.classList.add("inativo")

                const etiqueta = document.createElement("label")
                etiqueta.className = "checkbox-customizado"
                const chk = document.createElement("input")
                chk.type = "checkbox"
                chk.checked = item.ativo
                chk.onchange = () => this.#controladora.alternarStatus(item.id)
                const span = document.createElement("span")
                span.className = "marca-checkbox"
                etiqueta.append(chk, span)

                const esquerda = document.createElement("div")
                esquerda.className = "conteudo-esquerdo"
                const nome = document.createElement("div")
                nome.className = "nome-item"
                nome.innerText = item.nome
                const mat = document.createElement("div")
                mat.className = "matematica-item"
                mat.innerText = `${item.qtd} x ${this.formatarMoeda(item.preco)}`
                esquerda.append(nome, mat)

                const direita = document.createElement("div")
                direita.className = "conteudo-direito"
                const total = document.createElement("div")
                total.className = "preco-total-item"
                total.innerText = this.formatarMoeda(item.total)

                const btnEdit = document.createElement("button")
                btnEdit.className = "botao-icone botao-editar"
                btnEdit.innerHTML = '<svg viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" fill="currentColor"/></svg>'
                btnEdit.onclick = () => this.preencherFormulario(item)

                const btnDel = document.createElement("button")
                btnDel.className = "botao-icone botao-deletar"
                btnDel.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M9,8H11V17H9V8M13,8H15V17H13V8Z" fill="currentColor"/></svg>'
                btnDel.onclick = () => this.#controladora.excluir(item.id)

                direita.append(total, btnEdit, btnDel)
                cartao.append(etiqueta, esquerda, direita)
                container.appendChild(cartao)
            }

            lerFormulario() {
                return {
                    id: document.getElementById("idItem").value,
                    nome: document.getElementById("entradaNome").value,
                    preco: this.#converterParaNumero(document.getElementById("entradaPreco").value),
                    qtd: parseInt(document.getElementById("entradaQtd").value, 10)
                }
            }

            preencherFormulario(item) {
                document.getElementById("idItem").value = item.id
                document.getElementById("entradaNome").value = item.nome
                document.getElementById("entradaPreco").value = this.#formatarInput(item.preco)
                document.getElementById("entradaQtd").value = item.qtd
                
                this.botaoSalvar.innerText = "Salvar Altera√ß√£o"
                this.botaoSalvar.classList.add("em-edicao")
                this.cabecalho.classList.add("editando")
                document.getElementById("entradaPreco").focus()
                window.scrollTo({ top: 0, behavior: "smooth" })
            }

            limparFormulario() {
                document.getElementById("idItem").value = ""
                document.getElementById("entradaNome").value = ""
                document.getElementById("entradaPreco").value = ""
                document.getElementById("entradaQtd").value = "1"
                
                this.botaoSalvar.innerText = "Adicionar Item"
                this.botaoSalvar.classList.remove("em-edicao")
                this.cabecalho.classList.remove("editando")
                document.getElementById("entradaNome").focus()
            }

            atualizarTotais(gasto, restante) {
                this.elementoTotal.innerText = this.formatarMoeda(gasto)
                this.elementoSaldo.innerText = this.formatarMoeda(restante)

                if (restante < 0) {
                    this.elementoSaldo.classList.remove("positivo")
                    this.elementoSaldo.classList.add("negativo")
                } else {
                    this.elementoSaldo.classList.remove("negativo")
                    this.elementoSaldo.classList.add("positivo")
                }
            }

            definirTema(ehEscuro) {
                if (ehEscuro) {
                    document.body.classList.add("modo-escuro")
                    this.botaoTema.innerHTML = this.iconeSol
                } else {
                    document.body.classList.remove("modo-escuro")
                    this.botaoTema.innerHTML = this.iconeLua
                }
            }

            definirOrcamento(valor) {
                if (valor > 0) {
                    this.entradaOrcamento.value = this.#formatarInput(valor)
                }
            }

            aplicarMascara(input) {
                let valor = input.value.replace(/\D/g, "")
                if (valor === "") { input.value = ""; return }
                valor = (parseInt(valor) / 100).toLocaleString("pt-BR", { minimumFractionDigits: 2 })
                input.value = valor
            }

            formatarMoeda(valor) {
                return valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })
            }

            #formatarInput(valor) {
                return valor.toFixed(2).replace(".", ",")
            }

            #converterParaNumero(valorStr) {
                if (!valorStr) return 0
                return parseFloat(valorStr.replace(/\./g, "").replace(",", "."))
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const visao = new VisaoCalculadoraDOM()
            visao.iniciar()
        })
    </script>
</body>
</html>